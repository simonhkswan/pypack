---
name: Lint

on:
  pull_request:
    types:
      - 'opened'
      - 'synchronize'
      - 'reopened'

jobs:
  build-wheels:
    name: Build Python ${{ format('3.{0}', matrix.pyv) }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        pyv:
          - 7
          - 8
          - 9
        os:
          - 'ubuntu-latest'
          - 'windows-latest'
          - 'macos-latest'

    steps:
      - uses: actions/checkout@v3
        if: ${{ !env.ACT }}

      - uses: actions/setup-python@v3
        with:
          python-version: ${{ format('3.{0}', matrix.pyv) }}
          architecture: 'x64'
          cache: 'pip'
          cache-dependency-path: 'pyproject.toml'

      - name: set platform variable
        run: echo "PLATFORM=$(echo ${{ runner.os }}-${{ runner.arch }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
        shell: bash

      - name: pip-compile
        if: ${{ !env.ACT }}
        run: |
          pip install pip-tools
          pip-compile --no-annotate --no-header --output-file requirements/${PLATFORM}-py3${{ matrix.pyv }}-requirements.txt
          git add requirements
          IFS=$'\n'
          for LINE in $(git blame -s requirements/${PLATFORM}-py3${{ matrix.pyv }}-requirements.txt | sed  -lnE 's#^00000000 requirements/(.+).txt ([0-9]+).*#::error file=requirements/\1.txt,line=\2,endLine=\2,title=Requirement Changed::Update needed#ip'); do; echo $LINE; done
          git diff --cached --exit-code -- requirements
